# .github/workflows/release.yml
# Fixed GitHub Actions workflow for automated multi-platform releases

name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller pywebview
    
    - name: Build Windows executable
      run: |
        pyinstaller --noconfirm --onefile --windowed --name "MarkdownTableExporter-Windows" --add-data "templates;templates" --add-data "static;static" gui_app.py
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: dist/MarkdownTableExporter-Windows.exe

  build-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller pywebview
    
    - name: Build macOS application
      run: |
        pyinstaller --noconfirm --onefile --windowed --name "MarkdownTableExporter-macOS" --add-data "templates:templates" --add-data "static:static" gui_app.py
    
    - name: Upload macOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-build
        path: dist/MarkdownTableExporter-macOS

  build-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-gi python3-gi-cairo gir1.2-gtk-3.0 gir1.2-webkit2-4.0
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller pywebview[gtk]
    
    - name: Build Linux executable
      run: |
        pyinstaller --noconfirm --onefile --windowed --name "MarkdownTableExporter-Linux" --add-data "templates:templates" --add-data "static:static" gui_app.py
    
    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: linux-build
        path: dist/MarkdownTableExporter-Linux

  create-release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
    
    - name: Get tag name
      id: tag_name
      run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.tag_name.outputs.TAG_NAME }}
        name: Markdown Table Exporter ${{ steps.tag_name.outputs.TAG_NAME }}
        body: |
          ## üöÄ Markdown Table Exporter ${{ steps.tag_name.outputs.TAG_NAME }}
          
          Transform your Markdown tables into beautiful, interactive HTML documents!
          
          ### üì¶ Downloads
          
          Choose the right version for your operating system:
          
          | Platform | Download | System Requirements |
          |----------|----------|-------------------|
          | ü™ü **Windows** | `MarkdownTableExporter-Windows.exe` | Windows 10+ |
          | üçé **macOS** | `MarkdownTableExporter-macOS` | macOS 10.14+ |
          | üêß **Linux** | `MarkdownTableExporter-Linux` | Ubuntu 18.04+ |
          
          ### ‚ú® Features
          - Modern Material 3 design with spring animations
          - Drag & drop file loading with visual feedback
          - Light/dark theme support with smooth transitions
          - Export to CSV, PDF, and HTML
          - Command palette (Ctrl+K) for power users
          - Real-time table validation and error handling
          
          ### üîß System Requirements
          - **Windows**: Windows 10 or later (64-bit)
          - **macOS**: macOS 10.14 (Mojave) or later
          - **Linux**: Ubuntu 18.04 or equivalent
          - **Memory**: 256MB RAM minimum
          - **Storage**: 100MB available space
          
          ### üéõÔ∏è Usage
          1. Download the appropriate file for your operating system
          2. Run the executable (no Python installation required)
          3. Load your Markdown file via drag & drop or file browser
          4. Convert to beautiful HTML with one click
          5. Export in additional formats as needed
          
          ### ‚å®Ô∏è Keyboard Shortcuts
          - `Ctrl+K` - Open command palette
          - `Ctrl+O` - Open file dialog
          - `Ctrl+T` - Toggle theme
          - `Ctrl+Enter` - Start conversion
          - `F1` - Show help dialog
          - `Esc` - Close dialogs/palette
          
          ### üìñ Documentation
          For detailed instructions and examples, see the [README](https://github.com/Econ01/markdown-table-exporter/blob/main/README.md).
        draft: false
        prerelease: false
        files: |
          windows-build/MarkdownTableExporter-Windows.exe
          macos-build/MarkdownTableExporter-macOS
          linux-build/MarkdownTableExporter-Linux
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}